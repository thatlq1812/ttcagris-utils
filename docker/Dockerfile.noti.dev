# =============================================================================
# Dockerfile for Notification Service - Development
# =============================================================================
# Uses pre-built binary to avoid Go version and Azure DevOps auth issues
#
# Build binary first:
#   Windows: $env:CGO_ENABLED="0"; $env:GOOS="linux"; $env:GOARCH="amd64"; go build -o bin/noti-linux ./cmd/main.go
#   Linux:   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/noti-linux ./cmd/main.go
#
# IMPORTANT: Ensure fcm-dev-sdk.json exists in noti-service/config/
# =============================================================================

FROM alpine:3.19

# Install runtime dependencies
RUN apk add --no-cache \
  ca-certificates \
  tzdata \
  wget \
  curl

# Create non-root user
RUN addgroup -g 1000 appuser && \
  adduser -D -u 1000 -G appuser appuser

# Set working directory
WORKDIR /app

# Copy pre-built binary
COPY noti-service/bin/noti-linux /app/noti-service

# Copy templates
COPY noti-service/templates /app/templates

# Copy config (will be overridden by volume mount in compose)
COPY noti-service/config /app/config

# Set permissions
RUN chmod +x /app/noti-service && \
  chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Expose ports
EXPOSE 9012 8000

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
  CMD wget -qO- http://localhost:8000/health || exit 1

# Run the service (no subcommand needed, main() starts directly)
ENTRYPOINT ["/app/noti-service"]
