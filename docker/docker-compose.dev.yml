# =============================================================================
# Docker Compose for AgriOS Development Environment
# =============================================================================
# This compose file runs all required services for TOB-37, TOB-45, and TOB-46 testing:
#   - PostgreSQL (databases: centre_auth, notification_service, supplier_svc_db)
#   - Redis
#   - CAS Service (gRPC: 50051, HTTP: 4000)
#   - Noti-Service (gRPC: 9012, HTTP: 8000)
#   - Supplier Service (gRPC: 9088, HTTP: 8088)
#   - Web API Gateway (HTTP: 4001)
#
# Usage:
#   # Build and start all services
#   docker compose -f docker/docker-compose.dev.yml up -d --build
#
#   # View logs
#   docker compose -f docker/docker-compose.dev.yml logs -f
#
#   # Stop all services
#   docker compose -f docker/docker-compose.dev.yml down
#
#   # Full cleanup (remove volumes)
#   docker compose -f docker/docker-compose.dev.yml down -v
#
# Prerequisites:
#   1. Place FCM credentials at: noti-service/config/fcm-dev-sdk.json
#   2. Build binaries first (see below)
#
# Build binaries (Windows PowerShell):
#   $env:CGO_ENABLED="0"; $env:GOOS="linux"; $env:GOARCH="amd64"
#   cd centre-auth-service && go build -o bin/cas-linux ./cmd/app/ && cd ..
#   cd noti-service && go build -o bin/noti-linux ./cmd/main.go && cd ..
#   cd supplier-service && go build -o bin/supplier-linux ./cmd/main.go && cd ..
#   cd web-api-gateway && go build -o bin/webgw-linux ./cmd/app/ && cd ..
#
# Build binaries (Linux/macOS):
#   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o centre-auth-service/bin/cas-linux ./centre-auth-service/cmd/app/
#   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o noti-service/bin/noti-linux ./noti-service/cmd/main.go
#   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o supplier-service/bin/supplier-linux ./supplier-service/cmd/main.go
#   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web-api-gateway/bin/webgw-linux ./web-api-gateway/cmd/app/
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    container_name: agrios_dev_postgres
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agrios_network

  # ---------------------------------------------------------------------------
  # Redis Cache
  # ---------------------------------------------------------------------------
  redis:
    container_name: agrios_dev_redis
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: [ "redis-server", "--appendonly", "yes" ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - agrios_network

  # ---------------------------------------------------------------------------
  # Centre Auth Service (CAS)
  # ---------------------------------------------------------------------------
  cas-service:
    container_name: agrios_dev_cas
    build:
      context: ..
      dockerfile: docker/Dockerfile.cas.dev
    restart: unless-stopped
    ports:
      - "50051:50051" # gRPC
      - "4000:4000" # HTTP
    environment:
      # Server
      SERVER_NAME: cas-service
      SERVER_ENV: development
      SERVER_PORT: "4000"
      SERVER_DEBUG: "true"

      # gRPC
      GRPC_ENABLED: "true"
      GRPC_PORT: "50051"

      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_DATABASE: centre_auth
      DATABASE_SCHEMA: public
      DATABASE_SSL_MODE: disable

      # Redis
      CACHE_REDIS_MODE: standalone
      CACHE_REDIS_ADDRESS: redis:6379
      CACHE_REDIS_DB: "0"

      # JWT
      JWT_SECRET_KEY: dev-secret-key-change-in-production
      JWT_SECRET_KEY_WEB: dev-secret-key-web-change-in-production
      JWT_SECRET_KEY_APP: dev-secret-key-app-change-in-production
      JWT_ACCESS_TOKEN_DURATION: 15m
      JWT_REFRESH_TOKEN_DURATION: 168h

      # Services
      SERVICES_NOTIFICATION: noti-service:9012

      # Telemetry (disabled in dev)
      TELEMETRY_ENABLED: "false"
    volumes:
      - ../centre-auth-service/config:/app/config:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agrios_network
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:4000/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Notification Service
  # ---------------------------------------------------------------------------
  noti-service:
    container_name: agrios_dev_noti
    build:
      context: ..
      dockerfile: docker/Dockerfile.noti.dev
    restart: unless-stopped
    ports:
      - "9012:9012" # gRPC
      - "8000:8000" # HTTP
    environment:
      # Server
      SERVER_NAME: notification-service
      SERVER_GRPCPORT: ":9012"
      SERVER_RESTPORT: ":8000"
      SERVER_DEBUG: "true"

      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_DATABASE: notification_service
      DATABASE_SCHEMA: public
      DATABASE_OPTIONS: sslmode=disable

      # Redis
      REDIS_MODE: standalone
      REDIS_ADDRESS: redis:6379
      REDIS_DB: "0"

      # Firebase
      FIREBASE_CREDENTIALFILEPATH: /app/config/fcm-dev-sdk.json

      # Adapter (gRPC clients)
      ADAPTER_GRPC_CAS_SERVICE: cas-service:50051

      # Logger
      LOGGER_LEVEL: debug
      LOGGER_ENCODING: json
    volumes:
      - ../noti-service/config:/app/config:ro
      - ../noti-service/templates:/app/templates:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agrios_network
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Supplier Service
  # ---------------------------------------------------------------------------
  supplier-service:
    container_name: agrios_dev_supplier
    build:
      context: ..
      dockerfile: docker/Dockerfile.supplier.dev
    restart: unless-stopped
    ports:
      - "9088:9088" # gRPC
      - "8088:8088" # HTTP
    environment:
      # Server
      SERVER_NAME: supplier-service
      SERVER_RESTPORT: ":8088"
      SERVER_GRPCPORT: ":9088"
      SERVER_DEBUG: "true"

      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_DATABASE: supplier_svc_db
      DATABASE_SCHEMA: agrios
      DATABASE_OPTIONS: sslmode=disable

      # Redis
      REDIS_MODE: standalone
      REDIS_ADDRESS: redis:6379
      REDIS_DB: "0"

      # Logger
      LOGGER_LEVEL: debug
      LOGGER_ENCODING: json
    volumes:
      - ../supplier-service/config:/app/config:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - agrios_network
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8088/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Web API Gateway
  # ---------------------------------------------------------------------------
  web-api-gateway:
    container_name: agrios_dev_webgw
    build:
      context: ..
      dockerfile: docker/Dockerfile.webgw.dev
    restart: unless-stopped
    ports:
      - "4001:4001" # HTTP
    environment:
      # Server
      SERVER_NAME: web-api-gateway
      SERVER_PORT: "4001"
      SERVER_ENV: development
      SERVER_DEBUG: "true"

      # Use Docker-specific config file
      CONFIG_PATH: config/config.docker

      # Telemetry (disabled in dev)
      TELEMETRY_ENABLED: "false"
    volumes:
      - ../web-api-gateway/config:/app/config:ro
    depends_on:
      cas-service:
        condition: service_healthy
      supplier-service:
        condition: service_healthy
    networks:
      - agrios_network
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:4001/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  agrios_network:
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
  redis_data:
