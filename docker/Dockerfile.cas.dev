# =============================================================================
# Dockerfile for Centre Auth Service (CAS) - Development
# =============================================================================
# Uses pre-built binary to avoid Go version and Azure DevOps auth issues
#
# Build binary first:
#   Windows: $env:CGO_ENABLED="0"; $env:GOOS="linux"; $env:GOARCH="amd64"; go build -o bin/cas-linux ./cmd/app/
#   Linux:   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/cas-linux ./cmd/app/
# =============================================================================

FROM alpine:3.19

# Install runtime dependencies
RUN apk add --no-cache \
  ca-certificates \
  tzdata \
  wget \
  curl

# Create non-root user
RUN addgroup -g 1000 appuser && \
  adduser -D -u 1000 -G appuser appuser

# Set working directory
WORKDIR /app

# Copy pre-built binary
COPY centre-auth-service/bin/cas-linux /app/cas-service

# Copy migrations for reference (not auto-run)
COPY centre-auth-service/migrations /app/migrations

# Copy config (will be overridden by volume mount)
COPY centre-auth-service/config /app/config

# Set permissions
RUN chmod +x /app/cas-service && \
  chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Expose ports
EXPOSE 50051 4000

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
  CMD wget -qO- http://localhost:4000/health || exit 1

# Run the service with 'api' subcommand
ENTRYPOINT ["/app/cas-service", "api"]
